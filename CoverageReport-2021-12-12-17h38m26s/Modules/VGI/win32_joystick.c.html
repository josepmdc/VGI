<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>win32_joystick.c</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
    <body onload="prettyPrint()">
        <h4></h4>
        <pre class="prettyprint lang-cpp linenums">
//========================================================================
// GLFW 3.4 Win32 - www.glfw.org
//------------------------------------------------------------------------
// Copyright (c) 2002-2006 Marcus Geelnard
// Copyright (c) 2006-2019 Camilla LÃ¶wy &lt;elmindreda@glfw.org&gt;
//
// This software is provided 'as-is', without any express or implied
// warranty. In no event will the authors be held liable for any damages
// arising from the use of this software.
//
// Permission is granted to anyone to use this software for any purpose,
// including commercial applications, and to alter it and redistribute it
// freely, subject to the following restrictions:
//
// 1. The origin of this software must not be misrepresented; you must not
//    claim that you wrote the original software. If you use this software
//    in a product, an acknowledgment in the product documentation would
//    be appreciated but is not required.
//
// 2. Altered source versions must be plainly marked as such, and must not
//    be misrepresented as being the original software.
//
// 3. This notice may not be removed or altered from any source
//    distribution.
//
//========================================================================
// Please use C89 style variable declarations in this file because VS 2010
//========================================================================

#include "internal.h"

#include &lt;stdio.h&gt;
#include &lt;math.h&gt;

#define _GLFW_TYPE_AXIS     0
#define _GLFW_TYPE_SLIDER   1
#define _GLFW_TYPE_BUTTON   2
#define _GLFW_TYPE_POV      3

// Data produced with DirectInput device object enumeration
//
typedef struct _GLFWobjenumWin32
{
    IDirectInputDevice8W*   device;
    _GLFWjoyobjectWin32*    objects;
    int                     objectCount;
    int                     axisCount;
    int                     sliderCount;
    int                     buttonCount;
    int                     povCount;
} _GLFWobjenumWin32;

// Define local copies of the necessary GUIDs
//
static const GUID _glfw_IID_IDirectInput8W =
    {0xbf798031,0x483a,0x4da2,{0xaa,0x99,0x5d,0x64,0xed,0x36,0x97,0x00}};
static const GUID _glfw_GUID_XAxis =
    {0xa36d02e0,0xc9f3,0x11cf,{0xbf,0xc7,0x44,0x45,0x53,0x54,0x00,0x00}};
static const GUID _glfw_GUID_YAxis =
    {0xa36d02e1,0xc9f3,0x11cf,{0xbf,0xc7,0x44,0x45,0x53,0x54,0x00,0x00}};
static const GUID _glfw_GUID_ZAxis =
    {0xa36d02e2,0xc9f3,0x11cf,{0xbf,0xc7,0x44,0x45,0x53,0x54,0x00,0x00}};
static const GUID _glfw_GUID_RxAxis =
    {0xa36d02f4,0xc9f3,0x11cf,{0xbf,0xc7,0x44,0x45,0x53,0x54,0x00,0x00}};
static const GUID _glfw_GUID_RyAxis =
    {0xa36d02f5,0xc9f3,0x11cf,{0xbf,0xc7,0x44,0x45,0x53,0x54,0x00,0x00}};
static const GUID _glfw_GUID_RzAxis =
    {0xa36d02e3,0xc9f3,0x11cf,{0xbf,0xc7,0x44,0x45,0x53,0x54,0x00,0x00}};
static const GUID _glfw_GUID_Slider =
    {0xa36d02e4,0xc9f3,0x11cf,{0xbf,0xc7,0x44,0x45,0x53,0x54,0x00,0x00}};
static const GUID _glfw_GUID_POV =
    {0xa36d02f2,0xc9f3,0x11cf,{0xbf,0xc7,0x44,0x45,0x53,0x54,0x00,0x00}};

#define IID_IDirectInput8W _glfw_IID_IDirectInput8W
#define GUID_XAxis _glfw_GUID_XAxis
#define GUID_YAxis _glfw_GUID_YAxis
#define GUID_ZAxis _glfw_GUID_ZAxis
#define GUID_RxAxis _glfw_GUID_RxAxis
#define GUID_RyAxis _glfw_GUID_RyAxis
#define GUID_RzAxis _glfw_GUID_RzAxis
#define GUID_Slider _glfw_GUID_Slider
#define GUID_POV _glfw_GUID_POV

// Object data array for our clone of c_dfDIJoystick
// Generated with https://github.com/elmindreda/c_dfDIJoystick2
//
static DIOBJECTDATAFORMAT _glfwObjectDataFormats[] =
{
    { &amp;GUID_XAxis,DIJOFS_X,DIDFT_AXIS|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,DIDOI_ASPECTPOSITION },
    { &amp;GUID_YAxis,DIJOFS_Y,DIDFT_AXIS|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,DIDOI_ASPECTPOSITION },
    { &amp;GUID_ZAxis,DIJOFS_Z,DIDFT_AXIS|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,DIDOI_ASPECTPOSITION },
    { &amp;GUID_RxAxis,DIJOFS_RX,DIDFT_AXIS|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,DIDOI_ASPECTPOSITION },
    { &amp;GUID_RyAxis,DIJOFS_RY,DIDFT_AXIS|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,DIDOI_ASPECTPOSITION },
    { &amp;GUID_RzAxis,DIJOFS_RZ,DIDFT_AXIS|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,DIDOI_ASPECTPOSITION },
    { &amp;GUID_Slider,DIJOFS_SLIDER(0),DIDFT_AXIS|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,DIDOI_ASPECTPOSITION },
    { &amp;GUID_Slider,DIJOFS_SLIDER(1),DIDFT_AXIS|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,DIDOI_ASPECTPOSITION },
    { &amp;GUID_POV,DIJOFS_POV(0),DIDFT_POV|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { &amp;GUID_POV,DIJOFS_POV(1),DIDFT_POV|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { &amp;GUID_POV,DIJOFS_POV(2),DIDFT_POV|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { &amp;GUID_POV,DIJOFS_POV(3),DIDFT_POV|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(0),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(1),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(2),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(3),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(4),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(5),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(6),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(7),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(8),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(9),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(10),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(11),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(12),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(13),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(14),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(15),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(16),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(17),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(18),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(19),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(20),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(21),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(22),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(23),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(24),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(25),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(26),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(27),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(28),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(29),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(30),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
    { NULL,DIJOFS_BUTTON(31),DIDFT_BUTTON|DIDFT_OPTIONAL|DIDFT_ANYINSTANCE,0 },
};

// Our clone of c_dfDIJoystick
//
static const DIDATAFORMAT _glfwDataFormat =
{
    sizeof(DIDATAFORMAT),
    sizeof(DIOBJECTDATAFORMAT),
    DIDFT_ABSAXIS,
    sizeof(DIJOYSTATE),
    sizeof(_glfwObjectDataFormats) / sizeof(DIOBJECTDATAFORMAT),
    _glfwObjectDataFormats
};

// Returns a description fitting the specified XInput capabilities
//
static const char* getDeviceDescription(const XINPUT_CAPABILITIES* xic)
<span style = "background-color:#fdd">{
    switch (xic-&gt;SubType)</span>
    {
        case XINPUT_DEVSUBTYPE_WHEEL:
<span style = "background-color:#fdd">            return "XInput Wheel";</span>
        case XINPUT_DEVSUBTYPE_ARCADE_STICK:
<span style = "background-color:#fdd">            return "XInput Arcade Stick";</span>
        case XINPUT_DEVSUBTYPE_FLIGHT_STICK:
<span style = "background-color:#fdd">            return "XInput Flight Stick";</span>
        case XINPUT_DEVSUBTYPE_DANCE_PAD:
<span style = "background-color:#fdd">            return "XInput Dance Pad";</span>
        case XINPUT_DEVSUBTYPE_GUITAR:
<span style = "background-color:#fdd">            return "XInput Guitar";</span>
        case XINPUT_DEVSUBTYPE_DRUM_KIT:
<span style = "background-color:#fdd">            return "XInput Drum Kit";</span>
        case XINPUT_DEVSUBTYPE_GAMEPAD:
        {
<span style = "background-color:#fdd">            if (xic-&gt;Flags &amp; XINPUT_CAPS_WIRELESS)
                return "Wireless Xbox Controller";</span>
            else
<span style = "background-color:#fdd">                return "Xbox Controller";</span>
        }
    }

<span style = "background-color:#fdd">    return "Unknown XInput Device";
}</span>

// Lexically compare device objects
//
static int compareJoystickObjects(const void* first, const void* second)
<span style = "background-color:#fdd">{
    const _GLFWjoyobjectWin32* fo = first;
    const _GLFWjoyobjectWin32* so = second;</span>

<span style = "background-color:#fdd">    if (fo-&gt;type != so-&gt;type)
        return fo-&gt;type - so-&gt;type;</span>

<span style = "background-color:#fdd">    return fo-&gt;offset - so-&gt;offset;
}</span>

// Checks whether the specified device supports XInput
// Technique from FDInputJoystickManager::IsXInputDeviceFast in ZDoom
//
static GLFWbool supportsXInput(const GUID* guid)
<span style = "background-color:#fdd">{
    UINT i, count = 0;</span>
    RAWINPUTDEVICELIST* ridl;
<span style = "background-color:#fdd">    GLFWbool result = GLFW_FALSE;</span>

<span style = "background-color:#fdd">    if (GetRawInputDeviceList(NULL, &amp;count, sizeof(RAWINPUTDEVICELIST)) != 0)
        return GLFW_FALSE;</span>

<span style = "background-color:#fdd">    ridl = _glfw_calloc(count, sizeof(RAWINPUTDEVICELIST));</span>

<span style = "background-color:#fdd">    if (GetRawInputDeviceList(ridl, &amp;count, sizeof(RAWINPUTDEVICELIST)) == (UINT) -1)</span>
    {
<span style = "background-color:#fdd">        _glfw_free(ridl);
        return GLFW_FALSE;</span>
    }

<span style = "background-color:#fdd">    for (i = 0;  i &lt; count;  i++)</span>
    {
        RID_DEVICE_INFO rdi;
        char name[256];
        UINT size;

<span style = "background-color:#fdd">        if (ridl[i].dwType != RIM_TYPEHID)
            continue;</span>

<span style = "background-color:#fdd">        ZeroMemory(&amp;rdi, sizeof(rdi));
        rdi.cbSize = sizeof(rdi);
        size = sizeof(rdi);</span>

        if ((INT) GetRawInputDeviceInfoA(ridl[i].hDevice,
                                         RIDI_DEVICEINFO,
<span style = "background-color:#fdd">                                         &amp;rdi, &amp;size) == -1)</span>
        {
<span style = "background-color:#fdd">            continue;</span>
        }

<span style = "background-color:#fdd">        if (MAKELONG(rdi.hid.dwVendorId, rdi.hid.dwProductId) != (LONG) guid-&gt;Data1)
            continue;</span>

<span style = "background-color:#fdd">        memset(name, 0, sizeof(name));
        size = sizeof(name);</span>

        if ((INT) GetRawInputDeviceInfoA(ridl[i].hDevice,
                                         RIDI_DEVICENAME,
<span style = "background-color:#fdd">                                         name, &amp;size) == -1)</span>
        {
<span style = "background-color:#fdd">            break;</span>
        }

<span style = "background-color:#fdd">        name[sizeof(name) - 1] = '\0';
        if (strstr(name, "IG_"))</span>
        {
<span style = "background-color:#fdd">            result = GLFW_TRUE;
            break;</span>
        }
<span style = "background-color:#fdd">    }</span>

<span style = "background-color:#fdd">    _glfw_free(ridl);
    return result;
}</span>

// Frees all resources associated with the specified joystick
//
static void closeJoystick(_GLFWjoystick* js)
<span style = "background-color:#dfd">{
    if (js-&gt;win32.device)</span>
    {
<span style = "background-color:#fdd">        IDirectInputDevice8_Unacquire(js-&gt;win32.device);
        IDirectInputDevice8_Release(js-&gt;win32.device);</span>
    }

<span style = "background-color:#dfd">    _glfw_free(js-&gt;win32.objects);</span>

<span style = "background-color:#dfd">    _glfwFreeJoystick(js);
    _glfwInputJoystick(js, GLFW_DISCONNECTED);
}</span>

// DirectInput device object enumeration callback
// Insights gleaned from SDL
//
static BOOL CALLBACK deviceObjectCallback(const DIDEVICEOBJECTINSTANCEW* doi,
                                          void* user)
<span style = "background-color:#fdd">{
    _GLFWobjenumWin32* data = user;
    _GLFWjoyobjectWin32* object = data-&gt;objects + data-&gt;objectCount;</span>

<span style = "background-color:#fdd">    if (DIDFT_GETTYPE(doi-&gt;dwType) &amp; DIDFT_AXIS)</span>
    {
        DIPROPRANGE dipr;

<span style = "background-color:#fdd">        if (memcmp(&amp;doi-&gt;guidType, &amp;GUID_Slider, sizeof(GUID)) == 0)
            object-&gt;offset = DIJOFS_SLIDER(data-&gt;sliderCount);
        else if (memcmp(&amp;doi-&gt;guidType, &amp;GUID_XAxis, sizeof(GUID)) == 0)
            object-&gt;offset = DIJOFS_X;
        else if (memcmp(&amp;doi-&gt;guidType, &amp;GUID_YAxis, sizeof(GUID)) == 0)
            object-&gt;offset = DIJOFS_Y;
        else if (memcmp(&amp;doi-&gt;guidType, &amp;GUID_ZAxis, sizeof(GUID)) == 0)
            object-&gt;offset = DIJOFS_Z;
        else if (memcmp(&amp;doi-&gt;guidType, &amp;GUID_RxAxis, sizeof(GUID)) == 0)
            object-&gt;offset = DIJOFS_RX;
        else if (memcmp(&amp;doi-&gt;guidType, &amp;GUID_RyAxis, sizeof(GUID)) == 0)
            object-&gt;offset = DIJOFS_RY;
        else if (memcmp(&amp;doi-&gt;guidType, &amp;GUID_RzAxis, sizeof(GUID)) == 0)
            object-&gt;offset = DIJOFS_RZ;</span>
        else
<span style = "background-color:#fdd">            return DIENUM_CONTINUE;</span>

<span style = "background-color:#fdd">        ZeroMemory(&amp;dipr, sizeof(dipr));
        dipr.diph.dwSize = sizeof(dipr);
        dipr.diph.dwHeaderSize = sizeof(dipr.diph);
        dipr.diph.dwObj = doi-&gt;dwType;
        dipr.diph.dwHow = DIPH_BYID;
        dipr.lMin = -32768;
        dipr.lMax =  32767;</span>

<span style = "background-color:#fdd">        if (FAILED(IDirectInputDevice8_SetProperty(data-&gt;device,</span>
                                                   DIPROP_RANGE,
                                                   &amp;dipr.diph)))
        {
<span style = "background-color:#fdd">            return DIENUM_CONTINUE;</span>
        }

<span style = "background-color:#fdd">        if (memcmp(&amp;doi-&gt;guidType, &amp;GUID_Slider, sizeof(GUID)) == 0)</span>
        {
<span style = "background-color:#fdd">            object-&gt;type = _GLFW_TYPE_SLIDER;
            data-&gt;sliderCount++;
        }</span>
        else
        {
<span style = "background-color:#fdd">            object-&gt;type = _GLFW_TYPE_AXIS;
            data-&gt;axisCount++;</span>
        }
<span style = "background-color:#fdd">    }
    else if (DIDFT_GETTYPE(doi-&gt;dwType) &amp; DIDFT_BUTTON)</span>
    {
<span style = "background-color:#fdd">        object-&gt;offset = DIJOFS_BUTTON(data-&gt;buttonCount);
        object-&gt;type = _GLFW_TYPE_BUTTON;
        data-&gt;buttonCount++;
    }
    else if (DIDFT_GETTYPE(doi-&gt;dwType) &amp; DIDFT_POV)</span>
    {
<span style = "background-color:#fdd">        object-&gt;offset = DIJOFS_POV(data-&gt;povCount);
        object-&gt;type = _GLFW_TYPE_POV;
        data-&gt;povCount++;</span>
    }

<span style = "background-color:#fdd">    data-&gt;objectCount++;
    return DIENUM_CONTINUE;
}</span>

// DirectInput device enumeration callback
//
static BOOL CALLBACK deviceCallback(const DIDEVICEINSTANCE* di, void* user)
<span style = "background-color:#fdd">{
    int jid = 0;</span>
    DIDEVCAPS dc;
    DIPROPDWORD dipd;
    IDirectInputDevice8* device;
    _GLFWobjenumWin32 data;
    _GLFWjoystick* js;
    char guid[33];
    char name[256];

<span style = "background-color:#fdd">    for (jid = 0;  jid &lt;= GLFW_JOYSTICK_LAST;  jid++)</span>
    {
<span style = "background-color:#fdd">        js = _glfw.joysticks + jid;
        if (js-&gt;present)</span>
        {
<span style = "background-color:#fdd">            if (memcmp(&amp;js-&gt;win32.guid, &amp;di-&gt;guidInstance, sizeof(GUID)) == 0)
                return DIENUM_CONTINUE;</span>
        }
<span style = "background-color:#fdd">    }</span>

<span style = "background-color:#fdd">    if (supportsXInput(&amp;di-&gt;guidProduct))
        return DIENUM_CONTINUE;</span>

<span style = "background-color:#fdd">    if (FAILED(IDirectInput8_CreateDevice(_glfw.win32.dinput8.api,</span>
                                          &amp;di-&gt;guidInstance,
                                          &amp;device,
                                          NULL)))
    {
<span style = "background-color:#fdd">        _glfwInputError(GLFW_PLATFORM_ERROR, "Win32: Failed to create device");
        return DIENUM_CONTINUE;</span>
    }

<span style = "background-color:#fdd">    if (FAILED(IDirectInputDevice8_SetDataFormat(device, &amp;_glfwDataFormat)))</span>
    {
<span style = "background-color:#fdd">        _glfwInputError(GLFW_PLATFORM_ERROR,</span>
                        "Win32: Failed to set device data format");

<span style = "background-color:#fdd">        IDirectInputDevice8_Release(device);
        return DIENUM_CONTINUE;</span>
    }

<span style = "background-color:#fdd">    ZeroMemory(&amp;dc, sizeof(dc));
    dc.dwSize = sizeof(dc);</span>

<span style = "background-color:#fdd">    if (FAILED(IDirectInputDevice8_GetCapabilities(device, &amp;dc)))</span>
    {
<span style = "background-color:#fdd">        _glfwInputError(GLFW_PLATFORM_ERROR,</span>
                        "Win32: Failed to query device capabilities");

<span style = "background-color:#fdd">        IDirectInputDevice8_Release(device);
        return DIENUM_CONTINUE;</span>
    }

<span style = "background-color:#fdd">    ZeroMemory(&amp;dipd, sizeof(dipd));
    dipd.diph.dwSize = sizeof(dipd);
    dipd.diph.dwHeaderSize = sizeof(dipd.diph);
    dipd.diph.dwHow = DIPH_DEVICE;
    dipd.dwData = DIPROPAXISMODE_ABS;</span>

<span style = "background-color:#fdd">    if (FAILED(IDirectInputDevice8_SetProperty(device,</span>
                                               DIPROP_AXISMODE,
                                               &amp;dipd.diph)))
    {
<span style = "background-color:#fdd">        _glfwInputError(GLFW_PLATFORM_ERROR,</span>
                        "Win32: Failed to set device axis mode");

<span style = "background-color:#fdd">        IDirectInputDevice8_Release(device);
        return DIENUM_CONTINUE;</span>
    }

<span style = "background-color:#fdd">    memset(&amp;data, 0, sizeof(data));
    data.device = device;
    data.objects = _glfw_calloc(dc.dwAxes + (size_t) dc.dwButtons + dc.dwPOVs,</span>
                                sizeof(_GLFWjoyobjectWin32));

<span style = "background-color:#fdd">    if (FAILED(IDirectInputDevice8_EnumObjects(device,</span>
                                               deviceObjectCallback,
                                               &amp;data,
                                               DIDFT_AXIS | DIDFT_BUTTON | DIDFT_POV)))
    {
<span style = "background-color:#fdd">        _glfwInputError(GLFW_PLATFORM_ERROR,</span>
                        "Win32: Failed to enumerate device objects");

<span style = "background-color:#fdd">        IDirectInputDevice8_Release(device);
        _glfw_free(data.objects);
        return DIENUM_CONTINUE;</span>
    }

<span style = "background-color:#fdd">    qsort(data.objects, data.objectCount,</span>
          sizeof(_GLFWjoyobjectWin32),
          compareJoystickObjects);

<span style = "background-color:#fdd">    if (!WideCharToMultiByte(CP_UTF8, 0,</span>
                             di-&gt;tszInstanceName, -1,
                             name, sizeof(name),
                             NULL, NULL))
    {
<span style = "background-color:#fdd">        _glfwInputError(GLFW_PLATFORM_ERROR,</span>
                        "Win32: Failed to convert joystick name to UTF-8");

<span style = "background-color:#fdd">        IDirectInputDevice8_Release(device);
        _glfw_free(data.objects);
        return DIENUM_STOP;</span>
    }

    // Generate a joystick GUID that matches the SDL 2.0.5+ one
<span style = "background-color:#fdd">    if (memcmp(&amp;di-&gt;guidProduct.Data4[2], "PIDVID", 6) == 0)</span>
    {
<span style = "background-color:#fdd">        sprintf(guid, "03000000%02x%02x0000%02x%02x000000000000",</span>
                (uint8_t) di-&gt;guidProduct.Data1,
                (uint8_t) (di-&gt;guidProduct.Data1 &gt;&gt; 8),
                (uint8_t) (di-&gt;guidProduct.Data1 &gt;&gt; 16),
                (uint8_t) (di-&gt;guidProduct.Data1 &gt;&gt; 24));
<span style = "background-color:#fdd">    }</span>
    else
    {
<span style = "background-color:#fdd">        sprintf(guid, "05000000%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x00",</span>
                name[0], name[1], name[2], name[3],
                name[4], name[5], name[6], name[7],
                name[8], name[9], name[10]);
    }

<span style = "background-color:#fdd">    js = _glfwAllocJoystick(name, guid,</span>
                            data.axisCount + data.sliderCount,
                            data.buttonCount,
                            data.povCount);
<span style = "background-color:#fdd">    if (!js)</span>
    {
<span style = "background-color:#fdd">        IDirectInputDevice8_Release(device);
        _glfw_free(data.objects);
        return DIENUM_STOP;</span>
    }

<span style = "background-color:#fdd">    js-&gt;win32.device = device;
    js-&gt;win32.guid = di-&gt;guidInstance;
    js-&gt;win32.objects = data.objects;
    js-&gt;win32.objectCount = data.objectCount;</span>

<span style = "background-color:#fdd">    _glfwInputJoystick(js, GLFW_CONNECTED);
    return DIENUM_CONTINUE;
}</span>


//////////////////////////////////////////////////////////////////////////
//////                       GLFW internal API                      //////
//////////////////////////////////////////////////////////////////////////

// Checks for new joysticks after DBT_DEVICEARRIVAL
//
void _glfwDetectJoystickConnectionWin32(void)
<span style = "background-color:#fdd">{
    if (_glfw.win32.xinput.instance)</span>
    {
        DWORD index;

<span style = "background-color:#fdd">        for (index = 0;  index &lt; XUSER_MAX_COUNT;  index++)</span>
        {
            int jid;
            char guid[33];
            XINPUT_CAPABILITIES xic;
            _GLFWjoystick* js;

<span style = "background-color:#fdd">            for (jid = 0;  jid &lt;= GLFW_JOYSTICK_LAST;  jid++)</span>
            {
                if (_glfw.joysticks[jid].present &amp;&amp;
<span style = "background-color:#fdd">                    _glfw.joysticks[jid].win32.device == NULL &amp;&amp;</span>
                    _glfw.joysticks[jid].win32.index == index)
                {
<span style = "background-color:#fdd">                    break;</span>
                }
<span style = "background-color:#fdd">            }</span>

<span style = "background-color:#fdd">            if (jid &lt;= GLFW_JOYSTICK_LAST)
                continue;</span>

<span style = "background-color:#fdd">            if (XInputGetCapabilities(index, 0, &amp;xic) != ERROR_SUCCESS)
                continue;</span>

            // Generate a joystick GUID that matches the SDL 2.0.5+ one
<span style = "background-color:#fdd">            sprintf(guid, "78696e707574%02x000000000000000000",</span>
                    xic.SubType &amp; 0xff);

<span style = "background-color:#fdd">            js = _glfwAllocJoystick(getDeviceDescription(&amp;xic), guid, 6, 10, 1);
            if (!js)
                continue;</span>

<span style = "background-color:#fdd">            js-&gt;win32.index = index;</span>

<span style = "background-color:#fdd">            _glfwInputJoystick(js, GLFW_CONNECTED);
        }</span>
    }

<span style = "background-color:#fdd">    if (_glfw.win32.dinput8.api)</span>
    {
<span style = "background-color:#fdd">        if (FAILED(IDirectInput8_EnumDevices(_glfw.win32.dinput8.api,</span>
                                             DI8DEVCLASS_GAMECTRL,
                                             deviceCallback,
                                             NULL,
                                             DIEDFL_ALLDEVICES)))
        {
<span style = "background-color:#fdd">            _glfwInputError(GLFW_PLATFORM_ERROR,</span>
                            "Failed to enumerate DirectInput8 devices");
            return;
        }
    }
<span style = "background-color:#fdd">}</span>

// Checks for joystick disconnection after DBT_DEVICEREMOVECOMPLETE
//
void _glfwDetectJoystickDisconnectionWin32(void)
<span style = "background-color:#fdd">{</span>
    int jid;

<span style = "background-color:#fdd">    for (jid = 0;  jid &lt;= GLFW_JOYSTICK_LAST;  jid++)</span>
    {
<span style = "background-color:#fdd">        _GLFWjoystick* js = _glfw.joysticks + jid;
        if (js-&gt;present)
            _glfwPlatformPollJoystick(js, _GLFW_POLL_PRESENCE);
    }
}</span>


//////////////////////////////////////////////////////////////////////////
//////                       GLFW platform API                      //////
//////////////////////////////////////////////////////////////////////////

GLFWbool _glfwPlatformInitJoysticks(void)
<span style = "background-color:#fdd">{
    if (_glfw.win32.dinput8.instance)</span>
    {
<span style = "background-color:#fdd">        if (FAILED(DirectInput8Create(GetModuleHandle(NULL),</span>
                                      DIRECTINPUT_VERSION,
                                      &amp;IID_IDirectInput8W,
                                      (void**) &amp;_glfw.win32.dinput8.api,
                                      NULL)))
        {
<span style = "background-color:#fdd">            _glfwInputError(GLFW_PLATFORM_ERROR,</span>
                            "Win32: Failed to create interface");
<span style = "background-color:#fdd">            return GLFW_FALSE;</span>
        }
    }

<span style = "background-color:#fdd">    _glfwDetectJoystickConnectionWin32();
    return GLFW_TRUE;
}</span>

void _glfwPlatformTerminateJoysticks(void)
<span style = "background-color:#dfd">{</span>
    int jid;

<span style = "background-color:#dfd">    for (jid = GLFW_JOYSTICK_1;  jid &lt;= GLFW_JOYSTICK_LAST;  jid++)
        closeJoystick(_glfw.joysticks + jid);</span>

<span style = "background-color:#dfd">    if (_glfw.win32.dinput8.api)</span>
<span style = "background-color:#fdd">        IDirectInput8_Release(_glfw.win32.dinput8.api);</span>
<span style = "background-color:#dfd">}</span>

int _glfwPlatformPollJoystick(_GLFWjoystick* js, int mode)
<span style = "background-color:#fdd">{
    if (js-&gt;win32.device)</span>
    {
<span style = "background-color:#fdd">        int i, ai = 0, bi = 0, pi = 0;</span>
        HRESULT result;
        DIJOYSTATE state;

<span style = "background-color:#fdd">        IDirectInputDevice8_Poll(js-&gt;win32.device);
        result = IDirectInputDevice8_GetDeviceState(js-&gt;win32.device,</span>
                                                    sizeof(state),
                                                    &amp;state);
<span style = "background-color:#fdd">        if (result == DIERR_NOTACQUIRED || result == DIERR_INPUTLOST)</span>
        {
<span style = "background-color:#fdd">            IDirectInputDevice8_Acquire(js-&gt;win32.device);
            IDirectInputDevice8_Poll(js-&gt;win32.device);
            result = IDirectInputDevice8_GetDeviceState(js-&gt;win32.device,</span>
                                                        sizeof(state),
                                                        &amp;state);
        }

<span style = "background-color:#fdd">        if (FAILED(result))</span>
        {
<span style = "background-color:#fdd">            closeJoystick(js);
            return GLFW_FALSE;</span>
        }

<span style = "background-color:#fdd">        if (mode == _GLFW_POLL_PRESENCE)
            return GLFW_TRUE;</span>

<span style = "background-color:#fdd">        for (i = 0;  i &lt; js-&gt;win32.objectCount;  i++)</span>
        {
<span style = "background-color:#fdd">            const void* data = (char*) &amp;state + js-&gt;win32.objects[i].offset;</span>

<span style = "background-color:#fdd">            switch (js-&gt;win32.objects[i].type)</span>
            {
                case _GLFW_TYPE_AXIS:
                case _GLFW_TYPE_SLIDER:
                {
<span style = "background-color:#fdd">                    const float value = (*((LONG*) data) + 0.5f) / 32767.5f;
                    _glfwInputJoystickAxis(js, ai, value);
                    ai++;
                    break;</span>
                }

                case _GLFW_TYPE_BUTTON:
                {
<span style = "background-color:#fdd">                    const char value = (*((BYTE*) data) &amp; 0x80) != 0;
                    _glfwInputJoystickButton(js, bi, value);
                    bi++;
                    break;</span>
                }

                case _GLFW_TYPE_POV:
                {
<span style = "background-color:#fdd">                    const int states[9] =</span>
                    {
                        GLFW_HAT_UP,
                        GLFW_HAT_RIGHT_UP,
                        GLFW_HAT_RIGHT,
                        GLFW_HAT_RIGHT_DOWN,
                        GLFW_HAT_DOWN,
                        GLFW_HAT_LEFT_DOWN,
                        GLFW_HAT_LEFT,
                        GLFW_HAT_LEFT_UP,
                        GLFW_HAT_CENTERED
                    };

                    // Screams of horror are appropriate at this point
<span style = "background-color:#fdd">                    int stateIndex = LOWORD(*(DWORD*) data) / (45 * DI_DEGREES);
                    if (stateIndex &lt; 0 || stateIndex &gt; 8)
                        stateIndex = 8;</span>

<span style = "background-color:#fdd">                    _glfwInputJoystickHat(js, pi, states[stateIndex]);
                    pi++;</span>
                    break;
                }
            }
<span style = "background-color:#fdd">        }
    }</span>
    else
    {
<span style = "background-color:#fdd">        int i, dpad = 0;</span>
        DWORD result;
        XINPUT_STATE xis;
<span style = "background-color:#fdd">        const WORD buttons[10] =</span>
        {
            XINPUT_GAMEPAD_A,
            XINPUT_GAMEPAD_B,
            XINPUT_GAMEPAD_X,
            XINPUT_GAMEPAD_Y,
            XINPUT_GAMEPAD_LEFT_SHOULDER,
            XINPUT_GAMEPAD_RIGHT_SHOULDER,
            XINPUT_GAMEPAD_BACK,
            XINPUT_GAMEPAD_START,
            XINPUT_GAMEPAD_LEFT_THUMB,
            XINPUT_GAMEPAD_RIGHT_THUMB
        };

<span style = "background-color:#fdd">        result = XInputGetState(js-&gt;win32.index, &amp;xis);
        if (result != ERROR_SUCCESS)</span>
        {
<span style = "background-color:#fdd">            if (result == ERROR_DEVICE_NOT_CONNECTED)
                closeJoystick(js);</span>

<span style = "background-color:#fdd">            return GLFW_FALSE;</span>
        }

<span style = "background-color:#fdd">        if (mode == _GLFW_POLL_PRESENCE)
            return GLFW_TRUE;</span>

<span style = "background-color:#fdd">        _glfwInputJoystickAxis(js, 0, (xis.Gamepad.sThumbLX + 0.5f) / 32767.5f);
        _glfwInputJoystickAxis(js, 1, -(xis.Gamepad.sThumbLY + 0.5f) / 32767.5f);
        _glfwInputJoystickAxis(js, 2, (xis.Gamepad.sThumbRX + 0.5f) / 32767.5f);
        _glfwInputJoystickAxis(js, 3, -(xis.Gamepad.sThumbRY + 0.5f) / 32767.5f);
        _glfwInputJoystickAxis(js, 4, xis.Gamepad.bLeftTrigger / 127.5f - 1.f);
        _glfwInputJoystickAxis(js, 5, xis.Gamepad.bRightTrigger / 127.5f - 1.f);</span>

<span style = "background-color:#fdd">        for (i = 0;  i &lt; 10;  i++)</span>
        {
<span style = "background-color:#fdd">            const char value = (xis.Gamepad.wButtons &amp; buttons[i]) ? 1 : 0;
            _glfwInputJoystickButton(js, i, value);
        }</span>

<span style = "background-color:#fdd">        if (xis.Gamepad.wButtons &amp; XINPUT_GAMEPAD_DPAD_UP)
            dpad |= GLFW_HAT_UP;
        if (xis.Gamepad.wButtons &amp; XINPUT_GAMEPAD_DPAD_RIGHT)
            dpad |= GLFW_HAT_RIGHT;
        if (xis.Gamepad.wButtons &amp; XINPUT_GAMEPAD_DPAD_DOWN)
            dpad |= GLFW_HAT_DOWN;
        if (xis.Gamepad.wButtons &amp; XINPUT_GAMEPAD_DPAD_LEFT)
            dpad |= GLFW_HAT_LEFT;</span>

<span style = "background-color:#fdd">        _glfwInputJoystickHat(js, 0, dpad);</span>
    }

<span style = "background-color:#fdd">    return GLFW_TRUE;
}</span>

void _glfwPlatformUpdateGamepadGUID(char* guid)
<span style = "background-color:#dfd">{
    if (strcmp(guid + 20, "504944564944") == 0)</span>
    {
        char original[33];
<span style = "background-color:#fdd">        strncpy(original, guid, sizeof(original) - 1);
        sprintf(guid, "03000000%.4s0000%.4s000000000000",</span>
                original, original + 4);
    }
<span style = "background-color:#dfd">}</span>
</pre>
        <hr />
        <table width="100%">
            <thead>
                <tr>
                    <th align="center">
                        <small>Generated by</small>
                        <a href="https://github.com/OpenCppCoverage/OpenCppCoverage/releases">
                            <strong>OpenCppCoverage (Version: 0.9.9.0)</strong>
                        </a>
                    </th>
                </tr>
            </thead>
        </table>
    </body>
</html>